"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6895],{68868:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>h,contentTitle:()=>r,default:()=>d,frontMatter:()=>s,metadata:()=>o,toc:()=>l});var i=t(74848),a=t(28453);const s={title:"Rag Is Not Enough: Lessons from Beating GPT-3.5 on Specialized Tasks with Mistral 7B",description:"Creating Open Source Alternatives to Outperform ChatGPT",slug:"/blog/surpassing-chatgpt-with-open-source-alternatives",tags:["Open Source ChatGPT Alternatives","Outperform ChatGPT"],authors:["hahuyhoang411","0xsage","automaticcat"],date:new Date("2024-03-17T00:00:00.000Z")},r=void 0,o={id:"pending-content/blogpost/surpassing-chatgpt-with-open-source-alternatives",title:"Rag Is Not Enough: Lessons from Beating GPT-3.5 on Specialized Tasks with Mistral 7B",description:"Creating Open Source Alternatives to Outperform ChatGPT",source:"@site/docs/pending-content/blogpost/02-surpassing-chatgpt-with-open-source-alternatives.mdx",sourceDirName:"pending-content/blogpost",slug:"/blog/surpassing-chatgpt-with-open-source-alternatives",permalink:"/blog/surpassing-chatgpt-with-open-source-alternatives",draft:!1,unlisted:!1,editUrl:"https://github.com/janhq/docs/tree/main/docs/pending-content/blogpost/02-surpassing-chatgpt-with-open-source-alternatives.mdx",tags:[{label:"Open Source ChatGPT Alternatives",permalink:"/tags/open-source-chat-gpt-alternatives"},{label:"Outperform ChatGPT",permalink:"/tags/outperform-chat-gpt"}],version:"current",lastUpdatedBy:"Henry",lastUpdatedAt:1711369164,formattedLastUpdatedAt:"Mar 25, 2024",sidebarPosition:2,frontMatter:{title:"Rag Is Not Enough: Lessons from Beating GPT-3.5 on Specialized Tasks with Mistral 7B",description:"Creating Open Source Alternatives to Outperform ChatGPT",slug:"/blog/surpassing-chatgpt-with-open-source-alternatives",tags:["Open Source ChatGPT Alternatives","Outperform ChatGPT"],authors:["hahuyhoang411","0xsage","automaticcat"],date:"2024-03-17T00:00:00.000Z"}},h={},l=[{value:"Abstract",id:"abstract",level:2},{value:"Selecting a Strong Foundation Model",id:"selecting-a-strong-foundation-model",level:2},{value:"Cost-Effectively Improving the Base Model",id:"cost-effectively-improving-the-base-model",level:2},{value:"DPO Finetuning",id:"dpo-finetuning",level:2},{value:"Using Our Technical Documentation",id:"using-our-technical-documentation",level:2},{value:"Generating a Training Dataset for GPT-4",id:"generating-a-training-dataset-for-gpt-4",level:2},{value:"Training",id:"training",level:2},{value:"Improving Results With Rag",id:"improving-results-with-rag",level:2},{value:"Benchmarking the Results",id:"benchmarking-the-results",level:2},{value:"Conclusion",id:"conclusion",level:2},{value:"References",id:"references",level:2}];function c(e){const n={a:"a",code:"code",em:"em",h2:"h2",img:"img",li:"li",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"abstract",children:"Abstract"}),"\n",(0,i.jsxs)(n.p,{children:["We present a straightforward approach to adapting small, open-source models for specialized use cases, that can surpass GPT 3.5 performance with RAG. With it, we were able to get superior results on Q&A over ",(0,i.jsx)(n.a,{href:"https://nitro.jan.ai/docs",children:"technical documentation"})," describing a small ",(0,i.jsx)(n.a,{href:"https://github.com/janhq/nitro",children:"codebase"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["In short, (3) extending a general foundation model like ",(0,i.jsx)(n.a,{href:"https://huggingface.co/mistralai/Mistral-7B-v0.1",children:"Mistral"})," with strong math and coding, and (7) training it over a high-quality, synthetic dataset generated from the intended corpus, and (2) adding RAG capabilities, can lead to significant accuracy improvements."]}),"\n",(0,i.jsx)(n.p,{children:"Problems still arise with catastrophic forgetting in general tasks, commonly observed during specialized domain fine-tuning. In our case, this is likely exacerbated by our lack of access to Mistral\u2019s original training dataset and various compression techniques used in our approach to keep the model small."}),"\n",(0,i.jsx)(n.h2,{id:"selecting-a-strong-foundation-model",children:"Selecting a Strong Foundation Model"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://huggingface.co/mistralai/Mistral-7B-v0.1",children:"Mistral 7B"})," outshines both ",(0,i.jsx)(n.a,{href:"https://huggingface.co/meta-llama/Llama-2-7b",children:"Meta's Llama-2 7B"})," and ",(0,i.jsx)(n.a,{href:"https://huggingface.co/google/gemma-7b",children:"Google's Gemma 7B"})," in key benchmarks, making it our choice for a base model. Starting with a strong foundation like Mistral allowed us to achieve greater accuracy in our specialized adaptations."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Mistral vs LLama vs Gemma",src:t(5760).A+"",width:"1489",height:"790"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"Figure 1."})," Mistral 7B excels in benchmarks, ranking among the top foundational models."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.em,{children:["Note: we are not sponsored by the Mistral team. Though many folks in their community do like to run Mistral locally using our desktop client - ",(0,i.jsx)(n.a,{href:"https://jan.ai/",children:"Jan"}),"."]})}),"\n",(0,i.jsx)(n.h2,{id:"cost-effectively-improving-the-base-model",children:"Cost-Effectively Improving the Base Model"}),"\n",(0,i.jsx)(n.p,{children:"Mistral alone has known, poor math capabilities, which we needed for our highly technical use case. Thus, we tested all model variants on top of Mistral, from foundation models to finetunes to model merges, in order to find a stronger base model to receive our own finetuning."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Merged model vs finetuned models",src:t(11793).A+"",width:"1490",height:"790"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"Figure 2."})," The merged model, Stealth, doubles the mathematical capabilities of its foundational model while retaining the performance in other tasks."]}),"\n",(0,i.jsx)(n.p,{children:"We found merging models is quick and cost-effective, enabling fast adjustments based on the result of each iteration."}),"\n",(0,i.jsxs)(n.p,{children:["We ended up with ",(0,i.jsx)(n.a,{href:"https://huggingface.co/jan-hq/stealth-v1.1",children:"Stealth 7B v1.1"}),", a ",(0,i.jsx)(n.a,{href:"https://github.com/Digitous/LLM-SLERP-Merge",children:"SLERP"})," merge of Mistral with the following:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://huggingface.co/WizardLM/WizardMath-7B-V1.1",children:"WizardMath"})," for its math capabilities."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://huggingface.co/WizardLM/WizardCoder-Python-7B-V1.0",children:"WizardCoder"})," for its coding capabilities."]}),"\n",(0,i.jsxs)(n.li,{children:["Our own ",(0,i.jsx)(n.a,{href:"https://huggingface.co/jan-hq/trinity-v1.2",children:"Trinity"})," model for its versatility across general tasks."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This particular combination yielded the best tradeoff across mathematical & technical reasoning while retaining the most pre-merge performance on general tasks."}),"\n",(0,i.jsx)(n.h2,{id:"dpo-finetuning",children:"DPO Finetuning"}),"\n",(0,i.jsx)(n.p,{children:"Merging different LLMs can lead to a mixed answering style because each model was originally trained on different types of data."}),"\n",(0,i.jsxs)(n.p,{children:["Thus, we applied Direct Preference Optimization (",(0,i.jsx)(n.a,{href:"https://arxiv.org/abs/2305.18290",children:"DPO"}),") using the ",(0,i.jsx)(n.a,{href:"https://huggingface.co/datasets/Intel/orca_dpo_pairs",children:"Intel's Orca DPO pairs"})," dataset, chosen for its helpful answering style in general, math and coding concentration."]}),"\n",(0,i.jsxs)(n.p,{children:["This approach results in a final model - ",(0,i.jsx)(n.a,{href:"https://huggingface.co/jan-hq/stealth-v1.2",children:"Stealth 7B v1.2"}),", with minimal loss, and realign to our technical preferences."]}),"\n",(0,i.jsx)(n.h2,{id:"using-our-technical-documentation",children:"Using Our Technical Documentation"}),"\n",(0,i.jsx)(n.p,{children:"With the base model ready, we started on our specific use case."}),"\n",(0,i.jsx)(n.p,{children:"Jan is an open-source & bootstrapped project - at one point during our unanticipated growth, we received 1 customer support ticket per minute, with no one to handle customer service."}),"\n",(0,i.jsx)(n.p,{children:"So, we directed our efforts toward training a model to answer user questions based on existing technical documentation."}),"\n",(0,i.jsxs)(n.p,{children:["Specifically, we trained it on Nitro ",(0,i.jsx)(n.a,{href:"https://nitro.jan.ai/docs",children:"docs"}),". For context, Nitro is the default inference engine for Jan. It\u2019s a serious server implementation of LlamaCPP, written in C++, with multimodal, queues, and other production-level server capabilities."]}),"\n",(0,i.jsx)(n.p,{children:"It made an interesting corpus because it was rife with post-2023 technical jargon, edge cases, and poor informational layout."}),"\n",(0,i.jsx)(n.h2,{id:"generating-a-training-dataset-for-gpt-4",children:"Generating a Training Dataset for GPT-4"}),"\n",(0,i.jsxs)(n.p,{children:["The first step was to transform Nitro\u2019s unstructured format into a synthetic Q&A dataset designed for ",(0,i.jsx)(n.a,{href:"https://arxiv.org/pdf/2109.01652.pdf",children:"instruction tuning"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["The text was split into chunks of 300-token segments with 30-token overlaps. This helped to avoid a ",(0,i.jsx)(n.a,{href:"https://arxiv.org/abs/2307.03172",children:"lost-in-the-middle"})," problem where LLM can\u2019t use context efficiently to answer given questions."]}),"\n",(0,i.jsxs)(n.p,{children:["The chunks were then given to GPT-4 with 8k context length to generate 3800 Q&A pairs. The ",(0,i.jsx)(n.a,{href:"https://huggingface.co/datasets/jan-hq/nitro_binarized_v2",children:"training dataset"})," is available on HuggingFace."]}),"\n",(0,i.jsx)(n.h2,{id:"training",children:"Training"}),"\n",(0,i.jsxs)(n.p,{children:["The training was done with supervised finetuning (SFT) from the ",(0,i.jsx)(n.a,{href:"https://github.com/huggingface/alignment-handbook",children:"Hugging Face's alignment handbook"})," based on the ",(0,i.jsx)(n.a,{href:"https://github.com/huggingface/alignment-handbook/tree/main/recipes/zephyr-7b-beta",children:"Huggingface's Zephyr Beta"})," guidelines."]}),"\n",(0,i.jsxs)(n.p,{children:["We used consumer-grade, dual Nvidia RTX 4090s for the training. The end-to-end training took 18 minutes. We found optimal hyperparameters in LoRA for this specific task to be ",(0,i.jsx)(n.code,{children:"r = 256"})," and ",(0,i.jsx)(n.code,{children:"alpha = 512"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["This final model is publicly available at ",(0,i.jsx)(n.a,{href:"https://huggingface.co/jan-hq/nitro-v1.2-e3",children:"https://huggingface.co/jan-hq/nitro-v1.2-e3"}),"."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Using LLM locally",src:t(70595).A+"",width:"1607",height:"896"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"Figure 3."})," Using the new finetuned model in ",(0,i.jsx)(n.a,{href:"https://jan.ai/",children:"Jan"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"improving-results-with-rag",children:"Improving Results With Rag"}),"\n",(0,i.jsxs)(n.p,{children:["As an additional step, we also added ",(0,i.jsx)(n.a,{href:"https://blogs.nvidia.com/blog/what-is-retrieval-augmented-generation/",children:"Retrieval Augmented Generation (RAG)"})," as an experiment parameter."]}),"\n",(0,i.jsxs)(n.p,{children:["A simple RAG setup was done using ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.a,{href:"https://www.llamaindex.ai/",children:"Llamaindex"})})," and the ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.a,{href:"https://huggingface.co/BAAI/bge-base-en-v1.5",children:"bge-en-base-v1.5 embedding"})})," model for efficient documentation retrieval and question-answering. The RAG implementation is publicly available at at ",(0,i.jsx)(n.a,{href:"https://github.com/janhq/open-foundry/blob/main/rag-is-not-enough/rag/nitro_rag.ipynb",children:"https://github.com/janhq/open-foundry/blob/main/rag-is-not-enough/rag/nitro_rag.ipynb"})]}),"\n",(0,i.jsx)(n.h2,{id:"benchmarking-the-results",children:"Benchmarking the Results"}),"\n",(0,i.jsxs)(n.p,{children:["We curated a new set of ",(0,i.jsx)(n.a,{href:"https://github.com/janhq/open-foundry/blob/main/rag-is-not-enough/rag/mcq_nitro.csv",children:"50 multiple-choice questions"})," (MCQ) based on the Nitro docs. The questions had varying levels of difficulty and had trick components that challenged the model's ability to discern misleading information."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Opensource model outperforms GPT",src:t(90190).A+"",width:"1189",height:"590"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"Figure 4."})," Comparison between fine-tuned model and OpenAI's GPT."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"Table 1."})," Result of Benchmarking Different Model With RAG."]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Approach"}),(0,i.jsx)(n.th,{children:"Performance"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"GPT-3.5 with RAG"}),(0,i.jsx)(n.td,{children:"56.7%"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"GPT-4 with RAG"}),(0,i.jsx)(n.td,{children:"64.3%"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:["Merged 7B Model (",(0,i.jsx)(n.a,{href:"https://huggingface.co/jan-hq/stealth-v1.3",children:"Stealth 7B"}),") with RAG"]}),(0,i.jsx)(n.td,{children:"47.7%"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Finetuned 7B Model (Nitro 7B) with RAG"}),(0,i.jsx)(n.td,{children:"57.8%"})]})]})]}),"\n",(0,i.jsx)(n.p,{children:"This indicates that with task-specific training, we can improve an open-source, Small Language Model to the level of GPT-3.5 on domain knowledge."}),"\n",(0,i.jsx)(n.p,{children:"Notably, the finetuned with RAG approach also demonstrated more consistency across benchmarking, as indicated by its lower standard deviation."}),"\n",(0,i.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,i.jsx)(n.p,{children:"We conclude that this combination of model merging finetuning and RAG yields promise. This finding is relevant for teams and individuals that need specialized, technical SLMs that need to run in resource-constrained or highly secured environments, where GPT may not be an option."}),"\n",(0,i.jsx)(n.p,{children:"Anecdotally, we\u2019ve had some success using this model in practice to onboard new team members to the Nitro codebase."}),"\n",(0,i.jsxs)(n.p,{children:["A full research report with more statistics can be found at ",(0,i.jsx)(n.a,{href:"https://github.com/janhq/open-foundry/blob/main/rag-is-not-enough/README.md",children:"https://github.com/janhq/open-foundry/blob/main/rag-is-not-enough/README.md"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,i.jsxs)(n.p,{children:["[1] Jason Wei, Maarten Bosma, Vincent Y. Zhao, Kelvin Guu, Adams Wei Yu, Brian Lester, Nan Du, Andrew M. Dai, Quoc V. Le. Finetuned Language Models Are Zero-Shot Learners. ",(0,i.jsx)(n.em,{children:"arXiv preprint arXiv:2109.01652"}),", 2021. URL: ",(0,i.jsx)(n.a,{href:"https://arxiv.org/abs/2109.01652",children:"https://arxiv.org/abs/2109.01652"})]}),"\n",(0,i.jsxs)(n.p,{children:["[2] Haipeng Luo, Qingfeng Sun, Can Xu, Pu Zhao, Jianguang Lou, Chongyang Tao, Xiubo Geng, Qingwei Lin, Shifeng Chen, Dongmei Zhang. WizardMath: Empowering Mathematical Reasoning for Large Language Models via Reinforced Evol-Instruct. ",(0,i.jsx)(n.em,{children:"arXiv preprint arXiv:2308.09583"}),", 2023. URL: ",(0,i.jsx)(n.a,{href:"https://arxiv.org/abs/2308.09583",children:"https://arxiv.org/abs/2308.09583"})]}),"\n",(0,i.jsxs)(n.p,{children:["[3] Luo, Y., Yang, Z., Meng, F., Li, Y., Zhou, J., & Zhang, Y. An Empirical Study of Catastrophic Forgetting in Large Language Models During Continual Fine-tuning. ",(0,i.jsx)(n.em,{children:"arXiv preprint arXiv:2308.08747"}),",2023 URL: ",(0,i.jsx)(n.a,{href:"https://arxiv.org/abs/2308.08747",children:"https://arxiv.org/abs/2308.08747"})]}),"\n",(0,i.jsxs)(n.p,{children:["[4] Ziyang Luo, Can Xu, Pu Zhao, Qingfeng Sun, Xiubo Geng, Wenxiang Hu, Chongyang Tao, Jing Ma, Qingwei Lin, Daxin Jiang. WizardCoder: Empowering Code Large Language Models with Evol-Instruct., ",(0,i.jsx)(n.em,{children:"arXiv preprint arXiv:2306.08568"}),", 2023. URL: ",(0,i.jsx)(n.a,{href:"https://arxiv.org/abs/2306.08568",children:"https://arxiv.org/abs/2306.08568"})]}),"\n",(0,i.jsxs)(n.p,{children:["[5] SciPhi-AI, Agent Search. GitHub. URL: ",(0,i.jsx)(n.a,{href:"https://github.com/SciPhi-AI/agent-search",children:"https://github.com/SciPhi-AI/agent-search"})]}),"\n",(0,i.jsxs)(n.p,{children:['[6] Nelson F. Liu, Kevin Lin, John Hewitt, Ashwin Paranjape, Michele Bevilacqua, Fabio Petroni, Percy Liang. "Lost in the Middle: How Language Models Use Long Contexts." ',(0,i.jsx)(n.em,{children:"arXiv preprint arXiv:2307.03172"}),", 2023. URL: ",(0,i.jsx)(n.a,{href:"https://arxiv.org/abs/2307.03172",children:"https://arxiv.org/abs/2307.03172"})]}),"\n",(0,i.jsxs)(n.p,{children:["[7] Luo, H., Sun, Q., Xu, C., Zhao, P., Lou, J., Tao, C., Geng, X., Lin, Q., Chen, S., & Zhang, D. WizardMath: Empowering Mathematical Reasoning for Large Language Models via Reinforced Evol-Instruct. ",(0,i.jsx)(n.em,{children:"arXiv preprint arXiv:2308.09583"}),", 2023. URL: ",(0,i.jsx)(n.a,{href:"https://arxiv.org/abs/2308.09583",children:"https://arxiv.org/abs/2308.09583"})]}),"\n",(0,i.jsxs)(n.p,{children:["[8] nlpxucan et al., WizardLM. GitHub. URL: ",(0,i.jsx)(n.a,{href:"https://github.com/nlpxucan/WizardLM",children:"https://github.com/nlpxucan/WizardLM"})]})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},5760:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/mistral-comparasion-8c8400408787c7a3a85d1072ab545a1d.png"},70595:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/nitro-on-jan-a26977d030ddcda2ca3e9fb868a8a49c.png"},90190:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/rag-comparasion-d1d1d6f9838abb8f707117cfdfee24d2.png"},11793:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/stealth-comparasion-e4f7494c465c9eaecee0fb2d0997eb1c.png"},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var i=t(96540);const a={},s=i.createContext(a);function r(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);